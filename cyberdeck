#!/bin/bash
#
# CyberDeck Interface v3.0 - Launcher Script
#
# Запускает CyberDeck interface с правильными настройками окружения
#

# Цвета для вывода
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Получаем директорию скрипта
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

VENV_DIR="$SCRIPT_DIR/venv"

# Баннер
echo -e "${BLUE}"
cat << "EOF"
  ██████╗██╗   ██╗██████╗ ███████╗██████╗
 ██╔════╝╚██╗ ██╔╝██╔══██╗██╔════╝██╔══██╗
 ██║      ╚████╔╝ ██████╔╝█████╗  ██████╔╝
 ██║       ╚██╔╝  ██╔══██╗██╔══╝  ██╔══██╗
 ╚██████╗   ██║   ██████╔╝███████╗██║  ██║
  ╚═════╝   ╚═╝   ╚═════╝ ╚══════╝╚═╝  ╚═╝

 ██████╗ ███████╗ ██████╗██╗  ██╗  v3.0
 ██╔══██╗██╔════╝██╔════╝██║ ██╔╝
 ██║  ██║█████╗  ██║     █████╔╝
 ██║  ██║██╔══╝  ██║     ██╔═██╗
 ██████╔╝███████╗╚██████╗██║  ██╗
 ╚═════╝ ╚══════╝ ╚═════╝╚═╝  ╚═╝
EOF
echo -e "${NC}"

echo -e "${GREEN}Starting CyberDeck Interface...${NC}\n"

# Проверка наличия виртуального окружения
if [ -d "$VENV_DIR" ]; then
    echo -e "${BLUE}[*]${NC} Virtual environment found at: $VENV_DIR"
    echo -e "${BLUE}[*]${NC} Activating virtual environment..."

    # Активация venv
    source "$VENV_DIR/bin/activate"

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}[✓]${NC} Virtual environment activated"
    else
        echo -e "${RED}[✗]${NC} Failed to activate virtual environment"
        echo -e "${YELLOW}[!]${NC} Using system Python instead"
    fi
else
    echo -e "${YELLOW}[!]${NC} Virtual environment not found at: $VENV_DIR"
    echo -e "${YELLOW}[!]${NC} Run: ${BLUE}bash install.sh${NC} to create it"
    echo -e "${YELLOW}[!]${NC} Using system Python..."
fi

# Проверка Python версии
PYTHON_CMD="python3"
if [ -f "$VENV_DIR/bin/python" ]; then
    PYTHON_CMD="$VENV_DIR/bin/python"
fi

PYTHON_VERSION=$($PYTHON_CMD --version 2>&1 | awk '{print $2}')
echo -e "${BLUE}[*]${NC} Python version: $PYTHON_VERSION"

# Проверка зависимостей
echo -e "${BLUE}[*]${NC} Checking dependencies..."
MISSING_DEPS=0

if ! $PYTHON_CMD -c "import urwid" 2>/dev/null; then
    echo -e "${RED}[✗]${NC} Missing dependency: urwid"
    MISSING_DEPS=1
fi

if ! $PYTHON_CMD -c "import yaml" 2>/dev/null; then
    echo -e "${RED}[✗]${NC} Missing dependency: PyYAML"
    MISSING_DEPS=1
fi

if ! $PYTHON_CMD -c "import numpy" 2>/dev/null; then
    echo -e "${RED}[✗]${NC} Missing dependency: numpy"
    MISSING_DEPS=1
fi

if [ $MISSING_DEPS -eq 1 ]; then
    echo -e "${YELLOW}[!]${NC} Missing dependencies detected"
    echo -e "${YELLOW}[!]${NC} Run: ${BLUE}bash install.sh${NC} to install all dependencies"
    echo -e "${YELLOW}[!]${NC} Or install manually:"
    echo -e "${YELLOW}[!]${NC}   ${BLUE}source venv/bin/activate${NC}"
    echo -e "${YELLOW}[!]${NC}   ${BLUE}pip install -r requirements.txt${NC}"
    exit 1
fi

echo -e "${GREEN}[✓]${NC} All dependencies found\n"

# Проверка конфигурации
if [ ! -f "config/main.yaml" ]; then
    echo -e "${RED}[✗]${NC} Configuration file not found: config/main.yaml"
    exit 1
fi

# Проверка прав для hardware access
if [ "$EUID" -eq 0 ]; then
    echo -e "${GREEN}[✓]${NC} Running as root - Full hardware access enabled"
else
    if ! groups | grep -q "gpio\|spi\|i2c"; then
        echo -e "${YELLOW}[!]${NC} Your user is not in gpio/spi/i2c groups"
        echo -e "${YELLOW}[!]${NC} Hardware modules may not work properly"
        echo -e "${YELLOW}[!]${NC} Solutions:"
        echo -e "${YELLOW}[!]${NC}   1. Run as root: ${BLUE}sudo ./cyberdeck${NC}"
        echo -e "${YELLOW}[!]${NC}   2. Add to groups: ${BLUE}sudo usermod -a -G gpio,spi,i2c \$USER${NC}"
        echo -e "${YELLOW}[!]${NC}      Then logout and login again\n"
    fi
fi

# Запуск приложения
echo -e "${GREEN}[*]${NC} Launching CyberDeck Interface...\n"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"

# Передаем все аргументы командной строки в Python скрипт
$PYTHON_CMD core/main.py "$@"

EXIT_CODE=$?

# Обработка выхода
echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

if [ $EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}[✓]${NC} CyberDeck Interface stopped normally"
else
    echo -e "${RED}[✗]${NC} CyberDeck Interface exited with error code: $EXIT_CODE"
    echo -e "${YELLOW}[!]${NC} Check logs in: ${BLUE}logs/${NC}"
fi

exit $EXIT_CODE
